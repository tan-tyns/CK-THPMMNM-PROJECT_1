name: Flask VPS Deploy (Simulation)

on:
  push:
    branches: [ "main" ]

jobs:
  # Job 1: Build & Test (Ph·∫ßn n√†y s·∫Ω XANH - Th√†nh c√¥ng)
  test-code:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    - name: Install & Test
      run: |
        pip install flask
        python app.py &
        sleep 5
        curl http://127.0.0.1:5000/
        echo "‚úÖ Code ch·∫°y ngon l√†nh ·ªü m√¥i tr∆∞·ªùng test!"

  # Job 2: Deploy to VPS (Ph·∫ßn n√†y th·ªÉ hi·ªán k·ªπ thu·∫≠t Deploy)
  deploy-vps:
    needs: test-code      # Ch·ªâ ch·∫°y khi test xong
    runs-on: ubuntu-latest
    steps:
      - name: Deploy qua giao th·ª©c SSH
        # S·ª≠ d·ª•ng action chuy√™n d·ª•ng ƒë·ªÉ SSH v√†o server
        uses: appleboy/ssh-action@master
        with:
          # C√°c bi·∫øn b√≠ m·∫≠t ƒë√£ c√†i ƒë·∫∑t trong Settings
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          # K·ªãch b·∫£n l·ªánh Linux s·∫Ω ch·∫°y tr√™n VPS th·∫≠t
          script: |
            # 1. T·∫°o th∆∞ m·ª•c d·ª± √°n (n·∫øu ch∆∞a c√≥)
            mkdir -p /var/www/my-project
            
            # 2. V√†o th∆∞ m·ª•c
            cd /var/www/my-project
            
            # 3. L·∫•y code m·ªõi nh·∫•t t·ª´ Git v·ªÅ
            # (Gi·∫£ ƒë·ªãnh server ƒë√£ c√†i git v√† clone l·∫ßn ƒë·∫ßu r·ªìi)
            git pull origin main
            
            # 4. C√†i ƒë·∫∑t c√°c th∆∞ vi·ªán Python m·ªõi (n·∫øu c√≥)
            # T·∫°o m√¥i tr∆∞·ªùng ·∫£o v√† c√†i ƒë·∫∑t
            python3 -m venv venvgi
            source venv/bin/activate
            pip install flask
            
            # 5. Kh·ªüi ƒë·ªông l·∫°i ·ª©ng d·ª•ng ƒë·ªÉ c·∫≠p nh·∫≠t code m·ªõi
            # (Gi·∫£ s·ª≠ ƒëang d√πng Systemd ƒë·ªÉ qu·∫£n l√Ω service)
            # sudo systemctl restart my-flask-app
            
            echo "üöÄ Deploy th√†nh c√¥ng l√™n VPS!"